@using SkillsManagement.Models
@{
    ViewData["Title"] = "Skills Analysis";
}

@section Styles {
    <link rel="stylesheet" href="~/css/skillsana.css" />
}

<div class="analysis-header">
    <div>
        <a asp-action="Index" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left"></i> Back to Skills
        </a>
        <h2>Skills Analysis & Insights</h2>
        <p class="text-muted">Comprehensive analysis of organizational skills and competencies</p>
    </div>
    <div>
        <button onclick="window.print()" class="btn btn-outline-primary">
            <i class="fas fa-print"></i> Print Report
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="summary-card">
            <i class="fas fa-layer-group fa-2x mb-3" style="color: #667eea;"></i>
            <h3>@(ViewBag.TopSkills != null ? ((Dictionary<string, int>)ViewBag.TopSkills).Values.Sum() : 0)</h3>
            <p>Total Skill Entries</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="summary-card">
            <i class="fas fa-lightbulb fa-2x mb-3" style="color: #ffc107;"></i>
            <h3>@(ViewBag.TopSkills != null ? ((Dictionary<string, int>)ViewBag.TopSkills).Count : 0)</h3>
            <p>Unique Skills</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="summary-card">
            <i class="fas fa-laptop-code fa-2x mb-3" style="color: #17a2b8;"></i>
            <h3>@(ViewBag.CategoryDistribution != null && ((Dictionary<string, int>)ViewBag.CategoryDistribution).ContainsKey("Technical") ? ((Dictionary<string, int>)ViewBag.CategoryDistribution)["Technical"] : 0)</h3>
            <p>Technical Skills</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="summary-card">
            <i class="fas fa-users fa-2x mb-3" style="color: #28a745;"></i>
            <h3>@(ViewBag.CategoryDistribution != null && ((Dictionary<string, int>)ViewBag.CategoryDistribution).ContainsKey("Soft") ? ((Dictionary<string, int>)ViewBag.CategoryDistribution)["Soft"] : 0)</h3>
            <p>Soft Skills</p>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Top Skills Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> Top 10 Skills in Organization</h5>
            </div>
            <div class="card-body">
                <canvas id="topSkillsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Proficiency Distribution Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Proficiency Level Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="proficiencyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Category Distribution -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Skills by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Category Breakdown List -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> Category Breakdown</h5>
            </div>
            <div class="card-body">
                @if (ViewBag.CategoryDistribution != null && ((Dictionary<string, int>)ViewBag.CategoryDistribution).Any())
                {
                    <ul class="distribution-list">
                        @foreach (var category in (Dictionary<string, int>)ViewBag.CategoryDistribution)
                        {
                            var total = ((Dictionary<string, int>)ViewBag.CategoryDistribution).Values.Sum();
                            var percentage = (category.Value * 100.0 / total).ToString("F1");

                            <li class="distribution-item">
                                <span class="distribution-label">
                                    <i class="fas fa-@(category.Key == "Technical" ? "laptop-code text-info" : "users text-success")"></i>
                                    @category.Key Skills
                                </span>
                                <div class="distribution-value">
                                    <span>@percentage%</span>
                                    <span class="distribution-count">@category.Value</span>
                                </div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted text-center py-4">No category data available</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Skills Gap Analysis -->
@if (ViewBag.SkillsGap != null && ((List<SkillGapViewModel>)ViewBag.SkillsGap).Any())
{
    <div class="card gap-card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0 text-dark">
                <i class="fas fa-exclamation-triangle"></i> Skills Gap Analysis
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <strong><i class="fas fa-info-circle"></i> Attention Required:</strong>
                The following skills have been identified with low average proficiency levels (below 3.0) and are represented by multiple employees. Consider organizing training programs to improve these competencies.
            </div>

            @foreach (var gap in (List<SkillGapViewModel>)ViewBag.SkillsGap)
            {
                <div class="gap-item">
                    <div class="gap-item-info">
                        <h6>@gap.SkillName</h6>
                        <small>
                            <i class="fas fa-users"></i> @gap.Count employee(s) with this skill
                        </small>
                    </div>
                    <div class="gap-badge">
                        Avg: @gap.AvgProficiency.ToString("F1")/5.0
                    </div>
                </div>
            }

            <div class="mt-3">
                <a asp-controller="Training" asp-action="Suggestions" class="btn btn-warning">
                    <i class="fas fa-lightbulb"></i> Suggest Training Programs
                </a>
            </div>
        </div>
    </div>
}
else
{
    <div class="insight-card mb-4">
        <h5><i class="fas fa-check-circle"></i> Excellent Skills Performance!</h5>
        <p>
            No significant skills gaps identified in the organization. All skills are maintained at satisfactory proficiency levels.
            Continue to monitor and support employee development to maintain this high standard.
        </p>
    </div>
}

<!-- Key Insights -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-star text-warning"></i> Most Popular Skills</h5>
            </div>
            <div class="card-body">
                @if (ViewBag.TopSkills != null && ((Dictionary<string, int>)ViewBag.TopSkills).Any())
                {
                    <ul class="distribution-list">
                        @foreach (var skill in ((Dictionary<string, int>)ViewBag.TopSkills).Take(5))
                        {
                            <li class="distribution-item">
                                <span class="distribution-label">
                                    <i class="fas fa-certificate text-primary"></i>
                                    @skill.Key
                                </span>
                                <span class="distribution-count">@skill.Value</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted text-center py-3">No skill data available</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-line text-success"></i> Proficiency Overview</h5>
            </div>
            <div class="card-body">
                @if (ViewBag.ProficiencyDistribution != null && ((Dictionary<string, int>)ViewBag.ProficiencyDistribution).Any())
                {
                    <ul class="distribution-list">
                        @foreach (var level in (Dictionary<string, int>)ViewBag.ProficiencyDistribution)
                        {
                            var badgeColor = level.Key.Contains("1") || level.Key.Contains("2") ? "bg-danger" :
                            level.Key.Contains("3") ? "bg-warning" : "bg-success";

                            <li class="distribution-item">
                                <span class="distribution-label">
                                    <i class="fas fa-signal"></i>
                                    @level.Key
                                </span>
                                <span class="distribution-count @badgeColor">@level.Value</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted text-center py-3">No proficiency data available</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="export-section">
    <h4><i class="fas fa-download"></i> Export Analysis Report</h4>
    <p>Download this comprehensive skills analysis for reporting and strategic planning</p>
    <div>
        <button class="btn btn-export" onclick="window.print()">
            <i class="fas fa-file-pdf"></i> Export as PDF
        </button>
        <button class="btn btn-export" onclick="alert('Excel export functionality would be implemented here')">
            <i class="fas fa-file-excel"></i> Export as Excel
        </button>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart.js default configuration
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        Chart.defaults.color = '#666';

        // Top Skills Bar Chart
        const topSkillsData = @Html.Raw(Json.Serialize(ViewBag.TopSkills ?? new Dictionary<string, int>()));
        const topSkillsLabels = Object.keys(topSkillsData);
        const topSkillsValues = Object.values(topSkillsData);

        const topSkillsCtx = document.getElementById('topSkillsChart').getContext('2d');
        new Chart(topSkillsCtx, {
            type: 'bar',
            data: {
                labels: topSkillsLabels,
                datasets: [{
                    label: 'Number of Employees',
                    data: topSkillsValues,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Proficiency Distribution Doughnut Chart
        const proficiencyData = @Html.Raw(Json.Serialize(ViewBag.ProficiencyDistribution ?? new Dictionary<string, int>()));
        const proficiencyLabels = Object.keys(proficiencyData);
        const proficiencyValues = Object.values(proficiencyData);

        const proficiencyCtx = document.getElementById('proficiencyChart').getContext('2d');
        new Chart(proficiencyCtx, {
            type: 'doughnut',
            data: {
                labels: proficiencyLabels,
                datasets: [{
                    data: proficiencyValues,
                    backgroundColor: [
                        '#dc3545',
                        '#fd7e14',
                        '#ffc107',
                        '#28a745',
                        '#20c997'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                }
            }
        });

        // Category Distribution Pie Chart
        const categoryData = @Html.Raw(Json.Serialize(ViewBag.CategoryDistribution ?? new Dictionary<string, int>()));
        const categoryLabels = Object.keys(categoryData);
        const categoryValues = Object.values(categoryData);

        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues,
                    backgroundColor: [
                        '#667eea',
                        '#28a745'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    </script>
}