@model VisitorManagement.Controllers.ReportsViewModel
@{
    ViewData["Title"] = "Reports & Analytics";
}

<link rel="stylesheet" href="~/css/repoindex.css" asp-append-version="true" />

<div class="reports-header">
    <h1 class="reports-title">
        <i class="fas fa-chart-bar"></i>
        Reports & Analytics
    </h1>
    <a href="@Url.Action("Export", new { startDate = Model.StartDate, endDate = Model.EndDate, format = "csv" })" class="btn-export">
        <i class="fas fa-download"></i>
        Export CSV
    </a>
</div>

<div class="filter-card">
    <form asp-action="Generate" method="post" class="filter-form">
        <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" name="startDate" class="form-input" value="@Model.StartDate.ToString("yyyy-MM-dd")" required />
        </div>
        <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="date" name="endDate" class="form-input" value="@Model.EndDate.ToString("yyyy-MM-dd")" required />
        </div>
        <div class="form-group">
            <label class="form-label">Report Type</label>
            <select name="reportType" class="form-input">
                <option value="summary">Summary</option>
                <option value="detailed">Detailed</option>
                <option value="trends">Trends</option>
            </select>
        </div>
        <div class="form-group">
            <button type="submit" class="btn-generate">
                <i class="fas fa-sync-alt"></i>
                Generate Report
            </button>
        </div>
    </form>
</div>

<div class="stats-grid">
    <div class="stat-card blue">
        <div class="stat-value">@Model.TotalVisits</div>
        <div class="stat-label">Total Visits</div>
    </div>
    <div class="stat-card green">
        <div class="stat-value">@Model.ApprovedVisits</div>
        <div class="stat-label">Approved Visits</div>
    </div>
    <div class="stat-card yellow">
        <div class="stat-value">@Model.PendingVisits</div>
        <div class="stat-label">Pending Visits</div>
    </div>
    <div class="stat-card red">
        <div class="stat-value">@Model.DeniedVisits</div>
        <div class="stat-label">Denied Visits</div>
    </div>
    <div class="stat-card purple">
        <div class="stat-value">@Model.TotalCheckIns</div>
        <div class="stat-label">Total Check-Ins</div>
    </div>
    <div class="stat-card blue">
        <div class="stat-value">@string.Format("{0:0.0}", Model.AverageVisitsPerDay)</div>
        <div class="stat-label">Avg Visits/Day</div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-line"></i>
            Visits Over Time
        </h3>
        <div class="chart-container">
            <canvas id="visitsChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-pie"></i>
            Visits by Status
        </h3>
        <div class="chart-container">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-building"></i>
            Top Companies
        </h3>
        @if (Model.TopCompanies != null && Model.TopCompanies.Any())
        {
            <ul class="top-list">
                @for (int i = 0; i < Math.Min(5, Model.TopCompanies.Count); i++)
                {
                    var company = Model.TopCompanies[i];
                    <li class="top-list-item">
                        <span class="item-rank">@(i + 1)</span>
                        <span class="item-name">@company.Company</span>
                        <span class="item-count">@company.Count visits</span>
                    </li>
                }
            </ul>
        }
        else
        {
            <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                <i class="fas fa-building" style="font-size: 2rem; opacity: 0.5; margin-bottom: 0.5rem;"></i>
                <p>No data available</p>
            </div>
        }
    </div>

    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-user-tie"></i>
            Top Hosts
        </h3>
        @if (Model.TopHosts != null && Model.TopHosts.Any())
        {
            <ul class="top-list">
                @for (int i = 0; i < Math.Min(5, Model.TopHosts.Count); i++)
                {
                    var host = Model.TopHosts[i];
                    <li class="top-list-item">
                        <span class="item-rank">@(i + 1)</span>
                        <span class="item-name">@host.HostName</span>
                        <span class="item-count">@host.Count visits</span>
                    </li>
                }
            </ul>
        }
        else
        {
            <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                <i class="fas fa-user-tie" style="font-size: 2rem; opacity: 0.5; margin-bottom: 0.5rem;"></i>
                <p>No data available</p>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Visits Over Time Chart
    const visitsData = @Html.Raw(Json.Serialize(Model.VisitsByDate));
    const visitsCtx = document.getElementById('visitsChart');

    new Chart(visitsCtx, {
        type: 'line',
        data: {
            labels: visitsData.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Visits',
                data: visitsData.map(d => d.count),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Status Distribution Chart
    const statusData = @Html.Raw(Json.Serialize(Model.VisitsByStatus));
    const statusCtx = document.getElementById('statusChart');

    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1)),
            datasets: [{
                data: statusData.map(d => d.count),
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#ef4444'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>