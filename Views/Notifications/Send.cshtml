@model SkillsManagement.Models.Notification
@{
    ViewData["Title"] = "Send Notification";
    var employees = ViewBag.Employees as List<SkillsManagement.Models.Employee>;

    // Get template parameters from query string
    var templateTitle = Context.Request.Query["title"].ToString();
    var templateMessage = Context.Request.Query["message"].ToString();
    var templateType = Context.Request.Query["type"].ToString();
}

@section Styles {
    <link rel="stylesheet" href="~/css/nsend.css" />
}

<div class="page-header mb-4">
    <div>
        <a asp-action="Index" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <h2>Send Notification</h2>
        <p class="text-muted">Send custom notifications to employees</p>
    </div>
    <div>
        <a asp-action="Templates" class="btn btn-outline-info">
            <i class="fas fa-file-alt"></i> View Templates
        </a>
    </div>
</div>

@if (!string.IsNullOrEmpty(templateTitle))
{
    <div class="alert alert-info alert-dismissible fade show">
        <i class="fas fa-check-circle"></i>
        <strong>Template Loaded!</strong> You can customize the message below before sending.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card form-card">
            <div class="card-body">
                <form asp-action="SendNotification" method="post">
                    @Html.AntiForgeryToken()

                    <!-- Notification Details -->
                    <h5 class="section-title"><i class="fas fa-bell"></i> Notification Details</h5>

                    <div class="mb-3">
                        <label asp-for="Title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input asp-for="Title"
                               class="form-control"
                               placeholder="e.g., Important Update"
                               required
                               maxlength="100"
                               value="@templateTitle" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Message" class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea asp-for="Message"
                                  class="form-control"
                                  rows="5"
                                  placeholder="Enter your message here..."
                                  required
                                  maxlength="500">@templateMessage</textarea>
                        <span asp-validation-for="Message" class="text-danger"></span>
                        <small class="text-muted">Maximum 500 characters</small>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Type" class="form-label">Notification Type <span class="text-danger">*</span></label>
                        <select asp-for="Type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="Alert" selected="@(templateType == "Alert")">Alert - Important system messages</option>
                            <option value="Update" selected="@(templateType == "Update")">Update - Profile or system updates</option>
                            <option value="Suggestion" selected="@(templateType == "Suggestion")">Suggestion - Recommendations</option>
                        </select>
                        <span asp-validation-for="Type" class="text-danger"></span>
                    </div>

                    <!-- Recipients Selection -->
                    <h5 class="section-title"><i class="fas fa-users"></i> Recipients</h5>

                    <div class="mb-3">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="sendToAll" name="sendToAll" />
                            <label class="form-check-label" for="sendToAll">
                                <strong>Send to All Active Employees</strong>
                                <small class="d-block text-muted">This will send the notification to all @employees.Count active employees</small>
                            </label>
                        </div>
                    </div>

                    <div id="employeeSelectionSection">
                        <div class="mb-3">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="employeeSearch" class="form-control" placeholder="Search employees..." />
                            </div>
                        </div>

                        <div class="employee-selection-grid" id="employeeGrid">
                            @foreach (var emp in employees.OrderBy(e => e.FullName))
                            {
                                <div class="employee-checkbox" data-name="@emp.FullName.ToLower()" data-dept="@emp.Department.ToLower()">
                                    <input type="checkbox" name="selectedEmployees" value="@emp.Id" id="emp_@emp.Id" />
                                    <label for="emp_@emp.Id">
                                        <div class="emp-avatar">@emp.FullName.Substring(0, 1)</div>
                                        <div class="emp-info">
                                            <strong>@emp.FullName</strong>
                                            <small>@emp.Department</small>
                                        </div>
                                        <i class="fas fa-check-circle check-icon"></i>
                                    </label>
                                </div>
                            }
                        </div>

                        <div class="selection-actions">
                            <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearAll()">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                            <span id="selectionCount" class="selection-count">0 selected</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane"></i> Send Notification
                        </button>
                        <a asp-action="Index" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-mobile-alt"></i> Preview</h5>
            </div>
            <div class="card-body">
                <div class="notification-preview">
                    <div class="preview-device">
                        <div class="preview-notification">
                            <div class="preview-icon" id="previewIcon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="preview-content">
                                <strong id="previewTitle">@(string.IsNullOrEmpty(templateTitle) ? "Notification Title" : templateTitle)</strong>
                                <p id="previewMessage">@(string.IsNullOrEmpty(templateMessage) ? "Your notification message will appear here..." : templateMessage)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Live preview
        document.querySelector('input[name="Title"]').addEventListener('input', function(e) {
            document.getElementById('previewTitle').textContent = e.target.value || 'Notification Title';
        });

        document.querySelector('textarea[name="Message"]').addEventListener('input', function(e) {
            document.getElementById('previewMessage').textContent = e.target.value || 'Your notification message will appear here...';
        });

        document.querySelector('select[name="Type"]').addEventListener('change', function(e) {
            const icon = document.getElementById('previewIcon');
            const iconElement = icon.querySelector('i');

            iconElement.className = '';
            switch(e.target.value) {
                case 'Alert':
                    iconElement.className = 'fas fa-exclamation-circle';
                    icon.style.background = '#dc3545';
                    break;
                case 'Update':
                    iconElement.className = 'fas fa-info-circle';
                    icon.style.background = '#0dcaf0';
                    break;
                case 'Suggestion':
                    iconElement.className = 'fas fa-lightbulb';
                    icon.style.background = '#ffc107';
                    break;
                default:
                    iconElement.className = 'fas fa-bell';
                    icon.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        });

        // Initialize preview icon if template is loaded
        @if (!string.IsNullOrEmpty(templateType))
        {
                <text>
                document.addEventListener('DOMContentLoaded', function() {
                    const typeSelect = document.querySelector('select[name="Type"]');
                    typeSelect.dispatchEvent(new Event('change'));
                });
                </text>
        }

        // Send to all toggle
        document.getElementById('sendToAll').addEventListener('change', function(e) {
            const selectionSection = document.getElementById('employeeSelectionSection');
            if (e.target.checked) {
                selectionSection.style.opacity = '0.5';
                selectionSection.style.pointerEvents = 'none';
            } else {
                selectionSection.style.opacity = '1';
                selectionSection.style.pointerEvents = 'auto';
            }
        });

        // Search functionality
        document.getElementById('employeeSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.employee-checkbox');

            checkboxes.forEach(box => {
                const name = box.getAttribute('data-name');
                const dept = box.getAttribute('data-dept');

                if (name.includes(searchTerm) || dept.includes(searchTerm)) {
                    box.style.display = 'block';
                } else {
                    box.style.display = 'none';
                }
            });
        });

        function selectAll() {
            const checkboxes = document.querySelectorAll('.employee-checkbox:not([style*="display: none"]) input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateCount();
        }

        function clearAll() {
            const checkboxes = document.querySelectorAll('input[name="selectedEmployees"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateCount();
        }

        function updateCount() {
            const checked = document.querySelectorAll('input[name="selectedEmployees"]:checked').length;
            document.getElementById('selectionCount').textContent = checked + ' selected';
        }

        document.querySelectorAll('input[name="selectedEmployees"]').forEach(cb => {
            cb.addEventListener('change', updateCount);
        });

        updateCount();
    </script>
}