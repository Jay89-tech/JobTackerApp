@model List<Qualification>
@{
    ViewData["Title"] = "Qualifications";
}

<div class="page-header">
    <div>
        <h2>Qualifications Management</h2>
        <p class="text-muted">Manage and track employee qualifications and certifications</p>
    </div>
    <div class="header-actions">
        <a asp-action="Analysis" class="btn btn-info">
            <i class="fas fa-chart-line"></i> Analysis & Insights
        </a>
    </div>
</div>

<!-- Filters Card -->
<div class="card filter-card mb-4">
    <div class="card-body">
        <form method="get" asp-action="Index" id="filterForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fas fa-search"></i> Search
                    </label>
                    <input type="text" 
                           name="searchTerm" 
                           class="form-control" 
                           placeholder="Search by title, institution, or employee..." 
                           value="@ViewBag.SearchTerm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i> From Date
                    </label>
                    <input type="date" 
                           name="startDate" 
                           class="form-control" 
                           value="@ViewBag.StartDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar-check"></i> To Date
                    </label>
                    <input type="date" 
                           name="endDate" 
                           class="form-control" 
                           value="@ViewBag.EndDate" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(ViewBag.SearchTerm) || !string.IsNullOrEmpty(ViewBag.StartDate) || !string.IsNullOrEmpty(ViewBag.EndDate))
            {
                <div class="mt-3">
                    <a href="@Url.Action("Index")" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                </div>
            }
        </form>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row stats-row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card stat-card-purple">
            <div class="stat-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-content">
                <h3>@Model.Count</h3>
                <p>Total Qualifications</p>
                <small>Across all employees</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card stat-card-blue">
            <div class="stat-icon">
                <i class="fas fa-university"></i>
            </div>
            <div class="stat-content">
                <h3>@Model.Select(q => q.Institution).Distinct().Count()</h3>
                <p>Unique Institutions</p>
                <small>Educational bodies</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card stat-card-green">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>@Model.Select(q => q.EmployeeId).Distinct().Count()</h3>
                <p>Qualified Employees</p>
                <small>With certifications</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card stat-card-orange">
            <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <h3>@Model.Count(q => q.CompletionDate >= DateTime.Now.AddYears(-1))</h3>
                <p>Recent (Last Year)</p>
                <small>New certifications</small>
            </div>
        </div>
    </div>
</div>

<!-- Qualifications Table -->
<div class="card table-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> All Qualifications
            </h5>
            <span class="badge bg-primary">@Model.Count results</span>
        </div>
    </div>
    <div class="card-body">
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover qualifications-table">
                    <thead>
                        <tr>
                            <th width="30%">Qualification</th>
                            <th width="20%">Employee</th>
                            <th width="20%">Institution</th>
                            <th width="15%">Completion Date</th>
                            <th width="10%" class="text-center">Age</th>
                            <th width="5%" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var qual in Model)
                        {
                            var yearsAgo = (DateTime.Now - qual.CompletionDate).Days / 365;
                            var isRecent = yearsAgo <= 1;
                            
                            <tr class="qualification-row">
                                <td>
                                    <div class="qual-title-cell">
                                        <div class="qual-icon-small">
                                            <i class="fas fa-certificate"></i>
                                        </div>
                                        <div>
                                            <strong class="qual-title">@qual.Title</strong>
                                            @if (!string.IsNullOrEmpty(qual.Description))
                                            {
                                                <br />
                                                <small class="text-muted qual-description">
                                                    @(qual.Description.Length > 60 ? qual.Description.Substring(0, 60) + "..." : qual.Description)
                                                </small>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="employee-cell">
                                        <div class="emp-avatar-mini">
                                            @((ViewData[$"Employee_{qual.EmployeeId}"]?.ToString() ?? "?").Substring(0, 1))
                                        </div>
                                        <span>@ViewData[$"Employee_{qual.EmployeeId}"]</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="institution-cell">
                                        <i class="fas fa-university text-primary"></i>
                                        <span>@qual.Institution</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="date-cell">
                                        <strong>@qual.CompletionDate.ToString("MMM yyyy")</strong>
                                        <br />
                                        <small class="text-muted">@qual.CompletionDate.ToString("dd/MM/yyyy")</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    @if (isRecent)
                                    {
                                        <span class="badge badge-new">
                                            <i class="fas fa-star"></i> New
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="age-badge">
                                            @yearsAgo yr@(yearsAgo != 1 ? "s" : "")
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="btn-group-vertical" role="group">
                                        <a asp-action="Details" 
                                           asp-route-id="@qual.Id" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a asp-action="ByEmployee" 
                                           asp-route-employeeId="@qual.EmployeeId" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="View All Employee Qualifications">
                                            <i class="fas fa-list"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination Info -->
            <div class="table-footer">
                <p class="text-muted mb-0">
                    Showing @Model.Count qualification@(Model.Count != 1 ? "s" : "")
                </p>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h4>No Qualifications Found</h4>
                <p class="text-muted">
                    @if (!string.IsNullOrEmpty(ViewBag.SearchTerm) || !string.IsNullOrEmpty(ViewBag.StartDate))
                    {
                        <span>No qualifications match your search criteria. Try adjusting your filters.</span>
                    }
                    else
                    {
                        <span>No qualifications have been added to the system yet.</span>
                        <br />
                        <span>Employees can add their qualifications through the mobile app.</span>
                    }
                </p>
                @if (!string.IsNullOrEmpty(ViewBag.SearchTerm) || !string.IsNullOrEmpty(ViewBag.StartDate))
                {
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                }
            </div>
        }
    </div>
</div>

@{
    var topInstitutionGroup = Model
        .GroupBy(q => q.Institution)
        .OrderByDescending(g => g.Count())
        .FirstOrDefault();

    var topQualificationGroup = Model
        .GroupBy(q => q.Title)
        .OrderByDescending(g => g.Count())
        .FirstOrDefault();
}


<!-- Quick Info Card -->
@if (Model.Any())
{
    <div class="card info-card mt-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-trophy text-warning"></i> Top Institution</h6>
                    @if (topInstitutionGroup != null)
                    {
                        <p class="mb-0">
                            <strong>@topInstitutionGroup.Key</strong>
                            <span class="text-muted">
                                (@topInstitutionGroup.Count() qualifications)
                            </span>
                        </p>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No data available</p>
                    }
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-medal text-success"></i> Most Common Qualification</h6>
                    @if (topQualificationGroup != null)
                    {
                        <p class="mb-0">
                            <strong>@topQualificationGroup.Key</strong>
                            <span class="text-muted">
                                (@topQualificationGroup.Count() employees)
                            </span>
                        </p>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No data available</p>
                    }
                </div>
            </div>
        </div>
    </div>
}


@section Scripts {
    <script>
        // Auto-submit form on date change
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.addEventListener('change', function() {
                // Optional: auto-submit on date selection
                // document.getElementById('filterForm').submit();
            });
        });

        // Highlight search term in results
        @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
        {
            <text>
            const searchTerm = '@ViewBag.SearchTerm'.toLowerCase();
            document.querySelectorAll('.qual-title, .institution-cell span').forEach(el => {
                const text = el.textContent;
                if (text.toLowerCase().includes(searchTerm)) {
                    el.style.background = 'rgba(255, 235, 59, 0.3)';
                    el.style.padding = '2px 4px';
                    el.style.borderRadius = '3px';
                }
            });
            </text>
        }
    </script>
}